<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>GoRide MVP - Samarinda & Kukar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    .form-box { 
      padding: 10px; 
      background:#f4f4f4; 
      position: relative; 
      z-index: 1000; 
    }
    #map { 
      height: calc(100vh - 200px); /* sisa layar setelah form */
    }
    input, button { 
      padding:8px; 
      margin:5px 0; 
      width:100%; 
    }
    .result { 
      margin-top:10px; 
      font-weight:bold; 
    }
  </style>
</head>
<body>
  <div class="form-box">
    <form id="orderForm">
      <label>Lokasi Jemput:</label>
      <input type="text" id="pickup" placeholder="Contoh: Mall Lembuswana" required>
      <label>Tujuan:</label>
      <input type="text" id="destination" placeholder="Contoh: Tenggarong" required>
      <button type="submit">Pesan</button>
    </form>
    <div class="result" id="result"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([-0.502106, 117.153709], 12); // Samarinda center
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];
    let routeLine;

    const API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6Ijk4Njk4MWMxOWVmODQwMDU4ZWJlZTA1M2M1MzQxZTAxIiwiaCI6Im11cm11cjY0In0="; // Ganti dengan API key ORS

    // Ambil koordinat dari alamat
    function getCoordinates(address, callback) {
      fetch(`https://nominatim.openstreetmap.org/search?format=json&countrycodes=ID&q=${address}`)
        .then(res => res.json())
        .then(data => {
          if (data.length > 0) {
            let lat = parseFloat(data[0].lat);
            let lon = parseFloat(data[0].lon);
            callback(lat, lon);
          } else {
            alert("Alamat tidak ditemukan: " + address);
          }
        });
    }

    // Ambil rute dari ORS
    function getRoute(lat1, lon1, lat2, lon2) {
      fetch(`https://api.openrouteservice.org/v2/directions/driving-car?api_key=${API_KEY}&start=${lon1},${lat1}&end=${lon2},${lat2}`)
        .then(res => res.json())
        .then(data => {
          if (data.routes && data.routes.length > 0) {
            let route = data.routes[0];
            let distance = (route.summary.distance / 1000).toFixed(2); // meter -> km

            // Tarif: Rp3.000 dasar + Rp1.500/km
            let price = 3000 + (distance * 1500);

            document.getElementById("result").innerHTML =
              `Jarak Jalan: ${distance} km<br>Harga: Rp${Math.round(price).toLocaleString()}`;

            // Gambar rute di peta
            let coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
            if (routeLine) map.removeLayer(routeLine);
            routeLine = L.polyline(coords, {color: 'blue'}).addTo(map);
            map.fitBounds(routeLine.getBounds());
          } else {
            alert("Rute tidak ditemukan!");
          }
        });
    }

    document.getElementById("orderForm").addEventListener("submit", function(e) {
      e.preventDefault();
      let pickup = document.getElementById("pickup").value;
      let destination = document.getElementById("destination").value;

      getCoordinates(pickup, function(lat1, lon1) {
        getCoordinates(destination, function(lat2, lon2) {
          // Hapus marker lama
          markers.forEach(m => map.removeLayer(m));
          markers = [];

          // Tambah marker jemput
          let m1 = L.marker([lat1, lon1]).addTo(map).bindPopup("Jemput: " + pickup).openPopup();
          markers.push(m1);

          // Tambah marker tujuan
          let m2 = L.marker([lat2, lon2]).addTo(map).bindPopup("Tujuan: " + destination).openPopup();
          markers.push(m2);

          // Ambil rute via ORS
          getRoute(lat1, lon1, lat2, lon2);
        });
      });
    });
  </script>
</body>
</html>
